USE GD1C2015

-- CREANDO ESQUEMA
BEGIN --TRANSACTION

IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = N'BOBBY_TABLES')
EXEC sys.sp_executesql N'CREATE SCHEMA [BOBBY_TABLES] AUTHORIZATION [gd]'

END --COMMIT

-- DROP DE TABLAS
IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.DEPOSITOS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.DEPOSITOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.COMISIONES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.COMISIONES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.FACTURAS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.FACTURAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.FUNCIONALIDADES_POR_ROL') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.FUNCIONALIDADES_POR_ROL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.FUNCIONALIDADES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.FUNCIONALIDADES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.INTENTOS_LOGIN') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.INTENTOS_LOGIN

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.RETIROS_EFECTIVO') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.RETIROS_EFECTIVO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ROLES_POR_USUARIO') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.ROLES_POR_USUARIO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.TARJETAS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.TARJETAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.TRANSFERENCIAS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.TRANSFERENCIAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.CHEQUES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.CHEQUES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.BANCOS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.BANCOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.EMISORES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.EMISORES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.OPERACIONES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.OPERACIONES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ROLES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.ROLES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.CUENTAS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.CUENTAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.CLIENTES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.CLIENTES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.TIPOS_DOCUMENTO') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.TIPOS_DOCUMENTO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ESTADOS_CUENTA') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.ESTADOS_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.USUARIOS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.USUARIOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.TIPOS_CUENTA') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.TIPOS_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MONEDAS') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.MONEDAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.PAISES') AND OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE BOBBY_TABLES.PAISES

--DROP DE PROCEDURES
IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.EXISTE_USUARIO'))
DROP PROCEDURE BOBBY_TABLES.EXISTE_USUARIO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.PASSWORD_CORRECTA'))
DROP PROCEDURE BOBBY_TABLES.PASSWORD_CORRECTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_PREGUNTA'))
DROP PROCEDURE BOBBY_TABLES.GET_PREGUNTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.RESPUESTA_CORRECTA'))
DROP PROCEDURE BOBBY_TABLES.RESPUESTA_CORRECTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.SET_PASSWORD'))
DROP PROCEDURE BOBBY_TABLES.SET_PASSWORD

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.INTENTO_LOGIN'))
DROP PROCEDURE BOBBY_TABLES.INTENTO_LOGIN

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ROLES_USUARIO'))
DROP PROCEDURE BOBBY_TABLES.GET_ROLES_USUARIO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ID_USUARIO'))
DROP PROCEDURE BOBBY_TABLES.GET_ID_USUARIO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ID_PAIS'))
DROP PROCEDURE BOBBY_TABLES.GET_ID_PAIS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ID_EMISOR'))
DROP PROCEDURE BOBBY_TABLES.GET_ID_EMISOR

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ID_BANCO'))
DROP PROCEDURE BOBBY_TABLES.GET_ID_BANCO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_BANCOS'))
DROP PROCEDURE BOBBY_TABLES.GET_BANCOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_PAISES'))
DROP PROCEDURE BOBBY_TABLES.GET_PAISES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.AGREGAR_CLIENTE'))
DROP PROCEDURE BOBBY_TABLES.AGREGAR_CLIENTE

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_CLIENTE'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_CLIENTE

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.BAJA_CLIENTE'))
DROP PROCEDURE BOBBY_TABLES.BAJA_CLIENTE

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_CLIENTE'))
DROP PROCEDURE BOBBY_TABLES.GET_CLIENTE

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_CLIENTE_DNI'))
DROP PROCEDURE BOBBY_TABLES.GET_CLIENTE_DNI

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_CLIENTE_MAIL'))
DROP PROCEDURE BOBBY_TABLES.GET_CLIENTE_MAIL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_TARJETAS_CLIENTE'))
DROP PROCEDURE BOBBY_TABLES.GET_TARJETAS_CLIENTE

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_CONTRASENIA'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_CONTRASENIA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.AGREGAR_CUENTA'))
DROP PROCEDURE BOBBY_TABLES.AGREGAR_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_CUENTA'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.BAJA_CUENTA'))
DROP PROCEDURE BOBBY_TABLES.BAJA_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_CUENTA'))
DROP PROCEDURE BOBBY_TABLES.GET_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_SALDO'))
DROP PROCEDURE BOBBY_TABLES.GET_SALDO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ESTADOS'))
DROP PROCEDURE BOBBY_TABLES.GET_ESTADOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_TIPOS_CUENTA'))
DROP PROCEDURE BOBBY_TABLES.GET_TIPOS_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_TIPO_CUENTA'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_TIPO_CUENTA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_COSTOS_TIPO'))
DROP PROCEDURE BOBBY_TABLES.GET_COSTOS_TIPO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_COSTOS_TIPO'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_COSTOS_TIPO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.AGREGAR_ROL'))
DROP PROCEDURE BOBBY_TABLES.AGREGAR_ROL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_ROL'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_ROL

IF EXISTS(SELECT * FROM systypes WHERE name = N'LISTA_INT')
DROP TYPE BOBBY_TABLES.LISTA_INT

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.BAJA_ROL'))
DROP PROCEDURE BOBBY_TABLES.BAJA_ROL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ACTIVAR_ROL'))
DROP PROCEDURE BOBBY_TABLES.ACTIVAR_ROL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ROL'))
DROP PROCEDURE BOBBY_TABLES.GET_ROL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ROL_NOM'))
DROP PROCEDURE BOBBY_TABLES.GET_ROL_NOM

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ROLES'))
DROP PROCEDURE BOBBY_TABLES.GET_ROLES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_FUNCIONALIDADES_ROL'))
DROP PROCEDURE BOBBY_TABLES.GET_FUNCIONALIDADES_ROL

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_FUNCIONALIDADES'))
DROP PROCEDURE BOBBY_TABLES.GET_FUNCIONALIDADES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ASOCIAR_TARJETA'))
DROP PROCEDURE BOBBY_TABLES.ASOCIAR_TARJETA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.DESASOCIAR_TARJETA'))
DROP PROCEDURE BOBBY_TABLES.DESASOCIAR_TARJETA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.MODIFICAR_TARJETA'))
DROP PROCEDURE BOBBY_TABLES.MODIFICAR_TARJETA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_TARJETA'))
DROP PROCEDURE BOBBY_TABLES.GET_TARJETA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.DEPOSITAR'))
DROP PROCEDURE BOBBY_TABLES.DEPOSITAR

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.RETIRAR_EFECTIVO'))
DROP PROCEDURE BOBBY_TABLES.RETIRAR_EFECTIVO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.TRANSFERIR'))
DROP PROCEDURE BOBBY_TABLES.TRANSFERIR

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.COMISIONES_USUARIO'))
DROP PROCEDURE BOBBY_TABLES.COMISIONES_USUARIO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ULTIMOS_DEPOSITOS'))
DROP PROCEDURE BOBBY_TABLES.ULTIMOS_DEPOSITOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ULTIMOS_RETIROS'))
DROP PROCEDURE BOBBY_TABLES.ULTIMOS_RETIROS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ULTIMAS_TRANSFERENCIAS'))
DROP PROCEDURE BOBBY_TABLES.ULTIMAS_TRANSFERENCIAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.CLIENTES_CON_CUENTAS_INHABILITADAS_POR_AUSENCIA_DE_PAGO'))
DROP PROCEDURE BOBBY_TABLES.CLIENTES_CON_CUENTAS_INHABILITADAS_POR_AUSENCIA_DE_PAGO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.CLIENTES_CON_MAS_COMISIONES_FACTURADAS'))
DROP PROCEDURE BOBBY_TABLES.CLIENTES_CON_MAS_COMISIONES_FACTURADAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.CLIENTES_CON_MAYOR_TRANSFERENCIA_ENTRE_CUENTAS_PROPIAS'))
DROP PROCEDURE BOBBY_TABLES.CLIENTES_CON_MAYOR_TRANSFERENCIA_ENTRE_CUENTAS_PROPIAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.PAISES_CON_MAS_MOVIMIENTOS'))
DROP PROCEDURE BOBBY_TABLES.PAISES_CON_MAS_MOVIMIENTOS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.FACTURADO_PARA_CADA_TIPO'))
DROP PROCEDURE BOBBY_TABLES.FACTURADO_PARA_CADA_TIPO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_CUENTAS_USUARIO'))
DROP PROCEDURE BOBBY_TABLES.GET_CUENTAS_USUARIO

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_MONEDAS'))
DROP PROCEDURE BOBBY_TABLES.GET_MONEDAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_ID_TARJETA'))
DROP PROCEDURE BOBBY_TABLES.GET_ID_TARJETA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.GET_TARJETAS'))
DROP PROCEDURE BOBBY_TABLES.GET_TARJETAS

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.FIND_CLIENTES'))
DROP PROCEDURE BOBBY_TABLES.FIND_CLIENTES

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.FIND_CUENTAS'))
DROP PROCEDURE BOBBY_TABLES.FIND_CUENTAS







--DROP DE FUNCIONES
IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ENCRIPTAR_TARJETA'))
DROP FUNCTION BOBBY_TABLES.ENCRIPTAR_TARJETA

IF EXISTS(SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID('BOBBY_TABLES.ULTIMOS_4_DIGITOS'))
DROP FUNCTION BOBBY_TABLES.ULTIMOS_4_DIGITOS

----------------------------------------
----------- CREANDO TABLAS -------------
-- LOGIN Y USUARIO

CREATE TABLE BOBBY_TABLES.FUNCIONALIDADES_POR_ROL(
	FUNCIONALIDAD INT NOT NULL,
	ROL INT NOT NULL
)

CREATE TABLE BOBBY_TABLES.FUNCIONALIDADES(
	FUN_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(120)
)

CREATE TABLE BOBBY_TABLES.ROLES(
	ROL_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(50),
	ESTADO BIT DEFAULT 1
)

CREATE TABLE BOBBY_TABLES.INTENTOS_LOGIN(
	INT_ID INT IDENTITY(1,1) PRIMARY KEY,
	USUARIO INT,
	FECHA DATETIME,
	ACCESO BIT -- 1 ES CORRECTO
)

CREATE TABLE BOBBY_TABLES.PAISES(
	PAI_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(250)
)

CREATE TABLE BOBBY_TABLES.ROLES_POR_USUARIO(
	ROL INT NOT NULL,
	USUARIO INT NOT NULL
)

CREATE TABLE BOBBY_TABLES.TIPOS_DOCUMENTO( --NO ESTÁ EN EL DER
	TIP_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(20)
)

CREATE TABLE BOBBY_TABLES.USUARIOS(
	USU_ID INT IDENTITY(1,1) PRIMARY KEY,
	USERNAME VARCHAR(40) NOT NULL UNIQUE,
	PASSWORD VARBINARY(32) NOT NULL,
	ESTADO BIT DEFAULT 1,
	FECHA_ALTA DATETIME, --TODO FALTA EN EL DER
	FECHA_MODIFICACION DATETIME, --TODO FALTA EN EL DER
	INTENTOS_FALLIDOS SMALLINT DEFAULT 0, --RESETEAR CUANDO INGRESA
	PREGUNTA_SECRETA VARCHAR(100),
	RESPUESTA VARBINARY(32)
)

CREATE TABLE BOBBY_TABLES.CLIENTES(
	CLI_ID INT IDENTITY(1,1) PRIMARY KEY,
	TIPO_DOC INT,
	NUMERO_DOC VARCHAR(10),
	NOMBRE VARCHAR(255),
	APELLIDO VARCHAR(255),
	PAIS INT,
	CALLE VARCHAR(255),
	PISO INT,
	DEPTO VARCHAR(10),
	LOCALIDAD VARCHAR(60) DEFAULT '',
	NACIONALIDAD INT,
	FECHA_NACIMIENTO DATETIME,
	MAIL VARCHAR(255),
	USUARIO INT,
	ESTADO BIT DEFAULT 1
	
)

-- CUENTAS Y TARJETAS

CREATE TABLE BOBBY_TABLES.MONEDAS(
	MON_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(30)
)

CREATE TABLE BOBBY_TABLES.EMISORES(
	EMI_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(60)
)

CREATE TABLE BOBBY_TABLES.TIPOS_CUENTA(
	TIP_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(9),
	COSTO_MANTENIMIENTO FLOAT,
	COSTO_TRANSACCION FLOAT,
	VIGENCIA INT --CANTIDAD DE DÍAS DE VIGENCIA
)

CREATE TABLE BOBBY_TABLES.ESTADOS_CUENTA(
	EST_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(30),
)

CREATE TABLE BOBBY_TABLES.CUENTAS(
	CUE_ID NUMERIC(18,0) IDENTITY(1,1) PRIMARY KEY,
	CLIENTE INT,
	PAIS INT,
	MONEDA INT,
	TIPO INT,
	FECHA_ALTA DATETIME,
	FECHA_EXPIRACION DATETIME,
	ESTADO INT,
	SALDO FLOAT DEFAULT 0,
	FECHA_CIERRE DATETIME --SOLO PARA LAS CUENTAS CERRADAS
)

CREATE TABLE BOBBY_TABLES.TARJETAS(
	TAR_ID INT IDENTITY(1,1) PRIMARY KEY,
	CLIENTE INT,
	ENCRIPTADO VARBINARY(20),
	LIMPIO VARCHAR(4),
	COD_SEGURIDAD VARBINARY(20),
	EMISOR INT,
	FECHA_EMISION DATETIME,
	FECHA_VENCIMIENTO DATETIME,
	ESTADO BIT DEFAULT 1
)

-- OPERACIONES
CREATE TABLE BOBBY_TABLES.CHEQUES(
	CHE_ID NUMERIC(18,0) IDENTITY(1,1) PRIMARY KEY,
	BANCO INT
)

CREATE TABLE BOBBY_TABLES.BANCOS(
	BAN_ID INT IDENTITY(1,1) PRIMARY KEY,
	NOMBRE VARCHAR(50),
	DIRECCION VARCHAR(150)
)

CREATE TABLE BOBBY_TABLES.DEPOSITOS(
	DEP_ID NUMERIC(18,0) PRIMARY KEY,
	TARJETA INT
)

CREATE TABLE BOBBY_TABLES.RETIROS_EFECTIVO(
	RET_ID NUMERIC(18,0) PRIMARY KEY,
	CHEQUE NUMERIC(18,0)
)

CREATE TABLE BOBBY_TABLES.TRANSFERENCIAS(
	TRA_ID NUMERIC(18,0) PRIMARY KEY,
	CUENTA_DESTINO NUMERIC(18,0),
	COSTO FLOAT
)

CREATE TABLE BOBBY_TABLES.OPERACIONES(
	OPE_ID NUMERIC(18,0) IDENTITY(1,1) PRIMARY KEY,
	CUENTA NUMERIC(18,0),
	MONEDA INT,
	FECHA DATETIME,
	IMPORTE FLOAT
)

CREATE TABLE BOBBY_TABLES.COMISIONES(
	COM_ID INT IDENTITY(1,1) PRIMARY KEY,
	DESCRIPCION VARCHAR(150), --NO ESTÁ EN EL DER
	OPERACION NUMERIC(18,0),
	CUENTA NUMERIC(18,0), --PARA FACTURACIÓN DE COSTOS DE CUENTA
	TIPO_CUENTA INT, --IDEM ANTERIOR
	IMPORTE FLOAT, --IDEM ANTERIOR
	FECHA DATETIME,
	FACTURA NUMERIC(18,0)
)

CREATE TABLE BOBBY_TABLES.FACTURAS(
	FAC_NRO NUMERIC(18,0) IDENTITY(1,1) PRIMARY KEY,
	TARJETA INT,
	PAGADO INT
)


--ALTER(S) DE TABLAS

--PK Y FK DE ROL EN FUNCIONALIDADES_POR_ROL
ALTER TABLE BOBBY_TABLES.FUNCIONALIDADES_POR_ROL ADD CONSTRAINT FUN_ROL_PK
PRIMARY KEY (FUNCIONALIDAD, ROL)

ALTER TABLE BOBBY_TABLES.FUNCIONALIDADES_POR_ROL ADD CONSTRAINT FUN_ROL_FK
FOREIGN KEY (ROL) REFERENCES BOBBY_TABLES.ROLES

--FK DE USUARIO EN INTENTOS_LOGIN
ALTER TABLE BOBBY_TABLES.INTENTOS_LOGIN ADD CONSTRAINT INT_USU_FK
FOREIGN KEY (USUARIO) REFERENCES BOBBY_TABLES.USUARIOS

--PK Y FKS EN ROLES_POR_USUARIO
ALTER TABLE BOBBY_TABLES.ROLES_POR_USUARIO ADD CONSTRAINT ROL_PK
PRIMARY KEY (ROL, USUARIO)

ALTER TABLE BOBBY_TABLES.ROLES_POR_USUARIO ADD CONSTRAINT ROL_USU_FK
FOREIGN KEY (USUARIO) REFERENCES BOBBY_TABLES.USUARIOS

ALTER TABLE BOBBY_TABLES.ROLES_POR_USUARIO ADD CONSTRAINT ROL_ROL_FK
FOREIGN KEY (ROL) REFERENCES BOBBY_TABLES.ROLES

--FKS EN CLIENTES
ALTER TABLE BOBBY_TABLES.CLIENTES ADD CONSTRAINT CLI_USU_FK
FOREIGN KEY (USUARIO) REFERENCES BOBBY_TABLES.USUARIOS

ALTER TABLE BOBBY_TABLES.CLIENTES ADD CONSTRAINT CLI_TIP_DOC_FK
FOREIGN KEY (TIPO_DOC) REFERENCES BOBBY_TABLES.TIPOS_DOCUMENTO

ALTER TABLE BOBBY_TABLES.CLIENTES ADD CONSTRAINT CLI_PAI_FK
FOREIGN KEY (PAIS) REFERENCES BOBBY_TABLES.PAISES

ALTER TABLE BOBBY_TABLES.CLIENTES ADD CONSTRAINT CLI_NAC_FK
FOREIGN KEY (NACIONALIDAD) REFERENCES BOBBY_TABLES.PAISES

--FKS EN CUENTAS
ALTER TABLE BOBBY_TABLES.CUENTAS ADD CONSTRAINT CUE_CLI_FK
FOREIGN KEY (CLIENTE) REFERENCES BOBBY_TABLES.CLIENTES

ALTER TABLE BOBBY_TABLES.CUENTAS ADD CONSTRAINT CUE_PAI_FK
FOREIGN KEY (PAIS) REFERENCES BOBBY_TABLES.PAISES

ALTER TABLE BOBBY_TABLES.CUENTAS ADD CONSTRAINT CUE_MON_FK
FOREIGN KEY (MONEDA) REFERENCES BOBBY_TABLES.MONEDAS

ALTER TABLE BOBBY_TABLES.CUENTAS ADD CONSTRAINT CUE_TIP_FK
FOREIGN KEY (TIPO) REFERENCES BOBBY_TABLES.TIPOS_CUENTA

ALTER TABLE BOBBY_TABLES.CUENTAS ADD CONSTRAINT CUE_EST_FK
FOREIGN KEY (ESTADO) REFERENCES BOBBY_TABLES.ESTADOS_CUENTA

--FKS EN TARJETAS
ALTER TABLE BOBBY_TABLES.TARJETAS ADD CONSTRAINT TAR_CLI_FK
FOREIGN KEY (CLIENTE) REFERENCES BOBBY_TABLES.CLIENTES

ALTER TABLE BOBBY_TABLES.TARJETAS ADD CONSTRAINT TAR_EMI_FK
FOREIGN KEY (EMISOR) REFERENCES BOBBY_TABLES.EMISORES

--FK BANCO EN CHEQUES
ALTER TABLE BOBBY_TABLES.CHEQUES ADD CONSTRAINT CHE_BAN_FK
FOREIGN KEY (BANCO) REFERENCES BOBBY_TABLES.BANCOS

--FK TARJETA EN DEPOSITOS
ALTER TABLE BOBBY_TABLES.DEPOSITOS ADD CONSTRAINT DEP_TAR_FK
FOREIGN KEY (TARJETA) REFERENCES BOBBY_TABLES.TARJETAS
--FK OPERACION EN DEPOSITOS (PERMITE HERENCIA)
ALTER TABLE BOBBY_TABLES.DEPOSITOS ADD CONSTRAINT DEP_OPE_FK
FOREIGN KEY (DEP_ID) REFERENCES BOBBY_TABLES.OPERACIONES

--FK CHEQUE EN RETIROS_EFECTIVO
ALTER TABLE BOBBY_TABLES.RETIROS_EFECTIVO ADD CONSTRAINT RET_CHE_FK
FOREIGN KEY (CHEQUE) REFERENCES BOBBY_TABLES.CHEQUES
--FK OPERACION EN RETIROS_EFECTIVO (PERMITE HERENCIA)
ALTER TABLE BOBBY_TABLES.RETIROS_EFECTIVO ADD CONSTRAINT RET_OPE_FK
FOREIGN KEY (RET_ID) REFERENCES BOBBY_TABLES.OPERACIONES

--FK CUENTA EN TRANSFERENCIAS
ALTER TABLE BOBBY_TABLES.TRANSFERENCIAS ADD CONSTRAINT TRA_CUE_FK
FOREIGN KEY (CUENTA_DESTINO) REFERENCES BOBBY_TABLES.CUENTAS
--FK OPERACION EN TRANSFERENCIAS (PERMITE HERENCIA)
ALTER TABLE BOBBY_TABLES.TRANSFERENCIAS ADD CONSTRAINT TRA_OPE_FK
FOREIGN KEY (TRA_ID) REFERENCES BOBBY_TABLES.OPERACIONES

--FKS EN OPERACIONES
ALTER TABLE BOBBY_TABLES.OPERACIONES ADD CONSTRAINT OPE_MON_FK
FOREIGN KEY (MONEDA) REFERENCES BOBBY_TABLES.MONEDAS

ALTER TABLE BOBBY_TABLES.OPERACIONES ADD CONSTRAINT OPE_CUE_FK
FOREIGN KEY (CUENTA) REFERENCES BOBBY_TABLES.CUENTAS

--FKS EN COMISION
ALTER TABLE BOBBY_TABLES.COMISIONES ADD CONSTRAINT COM_OPE_FK
FOREIGN KEY (OPERACION) REFERENCES BOBBY_TABLES.OPERACIONES

ALTER TABLE BOBBY_TABLES.COMISIONES ADD CONSTRAINT COM_CUE_FK
FOREIGN KEY (CUENTA) REFERENCES BOBBY_TABLES.CUENTAS

ALTER TABLE BOBBY_TABLES.COMISIONES ADD CONSTRAINT COM_TIP_FK
FOREIGN KEY (TIPO_CUENTA) REFERENCES BOBBY_TABLES.TIPOS_CUENTA

ALTER TABLE BOBBY_TABLES.COMISIONES ADD CONSTRAINT COM_FAC_FK
FOREIGN KEY (FACTURA) REFERENCES BOBBY_TABLES.FACTURAS

--FK EN FACTURAS
ALTER TABLE BOBBY_TABLES.FACTURAS ADD CONSTRAINT FAC_TAR_FK
FOREIGN KEY (TARJETA) REFERENCES BOBBY_TABLES.TARJETAS

--FUNCIONES DE TARJETA
GO
CREATE FUNCTION BOBBY_TABLES.ENCRIPTAR_TARJETA(@NUMERO_TARJETA NUMERIC(16,0)) RETURNS VARBINARY(20) AS
BEGIN
	DECLARE @PRIMEROS12 VARCHAR(12)
	DECLARE @ENCRIPTADO VARBINARY(20)
	
	SET @PRIMEROS12 = SUBSTRING(CONVERT(VARCHAR(16),@NUMERO_TARJETA), 1, 12)
	
	SET @ENCRIPTADO = HASHBYTES('SHA1',@PRIMEROS12)

	RETURN @ENCRIPTADO
END

GO
CREATE FUNCTION BOBBY_TABLES.ULTIMOS_4_DIGITOS(@NUMERO_TARJETA NUMERIC(16,0)) RETURNS VARCHAR(4) AS
BEGIN
	RETURN SUBSTRING(CONVERT(VARCHAR(16),@NUMERO_TARJETA), 13, 4)
END
GO


--INSERTANDO DATOS EN LAS TABLAS (MIGRACIÓN)

--AGREGANDO PAÍSES EXISTENTES DE LA TABLA MAESTRA
SET IDENTITY_INSERT BOBBY_TABLES.PAISES ON

INSERT INTO BOBBY_TABLES.PAISES(PAI_ID, NOMBRE)
SELECT DISTINCT Cli_Pais_Codigo, Cli_Pais_Desc FROM gd_esquema.Maestra
UNION
SELECT DISTINCT Cuenta_Pais_Codigo, Cuenta_Pais_Desc FROM gd_esquema.Maestra
UNION
SELECT DISTINCT Cuenta_Dest_Pais_Codigo, Cuenta_Dest_Pais_Desc FROM gd_esquema.Maestra
WHERE Cuenta_Dest_Pais_Codigo IS NOT NULL
ORDER BY Cli_Pais_Codigo;

SET IDENTITY_INSERT BOBBY_TABLES.PAISES OFF

--AGREGANDO ROLES PREDEFINIDOS
INSERT INTO BOBBY_TABLES.ROLES(NOMBRE)
VALUES('Administrador')
INSERT INTO BOBBY_TABLES.ROLES(NOMBRE)
VALUES('Cliente')

--AGREGANDO FUNCIONALIDADES
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(1, 'Alta Rol')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(2, 'Baja Rol')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(3, 'Modificación Rol')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(4, 'Alta Cliente')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(5, 'Baja Cliente')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(6, 'Modificación Cliente')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(7, 'Alta Cuenta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(8, 'Baja Cuenta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(9, 'Modificación Cuenta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(10, 'Modificación Costos de Cuenta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(11, 'Asociar Tarjeta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(12, 'Desasociar Tarjeta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(13, 'Modificar Datos Tarjeta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(14, 'Depositar')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(15, 'Retirar')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(16, 'Transferir')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(17, 'Facturar')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(18, 'Consultar Saldo Cliente')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(19, 'Modificar Contraseña')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(20, 'Modificar Categoría Cuenta')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(21, 'Listado Estadístico')
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES
VALUES(118, 'Consultar Saldo Administrador')

--AGREGANDO FUNCIONALIDADES POR ROL
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(1, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(2, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(3, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(4, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(5, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(6, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(7, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(8, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(9, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(10, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(11, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(12, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(13, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(14, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(15, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(16, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(17, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(118, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(19, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(20, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(21, 1)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(1,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(11,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(12,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(14,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(15,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(16,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(17,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(18,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(19,2)
INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
VALUES(20,2)

--AGREGANDO LA ÚNICA MOENDA EXISTENTE POR AHORA
INSERT INTO BOBBY_TABLES.MONEDAS
VALUES('Dólar EE UU')

--AGREGANDO LOS ESTADOS DE CUENTA MANUALMENTE YA QUE NO HAY CARGADOS
INSERT INTO BOBBY_TABLES.ESTADOS_CUENTA
VALUES('Habilitada')
INSERT INTO BOBBY_TABLES.ESTADOS_CUENTA
VALUES('Deshabilitada')
INSERT INTO BOBBY_TABLES.ESTADOS_CUENTA
VALUES('Pendiente de activación')
INSERT INTO BOBBY_TABLES.ESTADOS_CUENTA
VALUES('Cerrada')

--AGREGANDO TIPOS DE CUENTA FIJOS CON UN COSTO HARDCODEADO
INSERT INTO BOBBY_TABLES.TIPOS_CUENTA
VALUES('Gratuita', 0, 100, 30)
INSERT INTO BOBBY_TABLES.TIPOS_CUENTA
VALUES('Bronce', 10, 50, 30)
INSERT INTO BOBBY_TABLES.TIPOS_CUENTA
VALUES('Plata', 20, 15, 30)
INSERT INTO BOBBY_TABLES.TIPOS_CUENTA
VALUES('Oro', 30, 0, 30)

--AGREGANDO EMISORES EXISTENTES CON IDENTITY
INSERT INTO BOBBY_TABLES.EMISORES
SELECT DISTINCT Tarjeta_Emisor_Descripcion FROM gd_esquema.Maestra
WHERE Tarjeta_Emisor_Descripcion IS NOT NULL

--AGREGANDO TIPOS DE DOCUMENTOS EXISTENTES EN TABLA MAESTRA Y MANUALES
INSERT INTO BOBBY_TABLES.TIPOS_DOCUMENTO
VALUES(1, 'DNI')
INSERT INTO BOBBY_TABLES.TIPOS_DOCUMENTO
VALUES(2, 'CI')
INSERT INTO BOBBY_TABLES.TIPOS_DOCUMENTO
VALUES(3, 'LC')
INSERT INTO BOBBY_TABLES.TIPOS_DOCUMENTO
VALUES(4, 'LE')
INSERT INTO BOBBY_TABLES.TIPOS_DOCUMENTO --HARDCODEO EL PASAPORTE PARA FACILITAR LA APLICACIÓN
VALUES(5, 'PAS')

--AGREGANDO DATOS EN LA TABLA USUARIOS
INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA)
SELECT DISTINCT Cli_Mail, CONVERT(VARBINARY(32),'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855',2), GETDATE() FROM gd_esquema.Maestra --PASSWORD VACÍA

--ASGINANDO A TODOS LOS USUARIOS NUEVOS EL ROL DE CLIENTE
INSERT INTO BOBBY_TABLES.ROLES_POR_USUARIO
SELECT 2, USU_ID FROM BOBBY_TABLES.USUARIOS

--SET DE ADMINISTRADORES
INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA)
VALUES('admin', CONVERT(VARBINARY(32),'e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7',2),GETDATE())
INSERT INTO BOBBY_TABLES.ROLES_POR_USUARIO
VALUES(1,@@IDENTITY)
INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA)
VALUES('julieta', CONVERT(VARBINARY(32),'e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7',2),GETDATE())
INSERT INTO BOBBY_TABLES.ROLES_POR_USUARIO
VALUES(1,@@IDENTITY)
INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA)
VALUES('maximiliano', CONVERT(VARBINARY(32),'e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7',2),GETDATE())
INSERT INTO BOBBY_TABLES.ROLES_POR_USUARIO
VALUES(1,@@IDENTITY)
INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA)
VALUES('julian', CONVERT(VARBINARY(32),'e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7',2),GETDATE())
INSERT INTO BOBBY_TABLES.ROLES_POR_USUARIO
VALUES(1,@@IDENTITY)
INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA, PREGUNTA_SECRETA, RESPUESTA)
VALUES('martin', CONVERT(VARBINARY(32),'e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7',2),GETDATE(), '¿Cuál es tu color preferido?', CONVERT(VARBINARY(32),'9e3fc69d0d9cdcd532456f53c9c12909328ffeaab9046874a240c51fb813322d'))
INSERT INTO BOBBY_TABLES.ROLES_POR_USUARIO
VALUES(1,@@IDENTITY)

--AGREGANDO DATOS EN LA TABLA CLIENTES
INSERT INTO BOBBY_TABLES.CLIENTES(TIPO_DOC, NUMERO_DOC, NOMBRE, APELLIDO, PAIS, CALLE, PISO, DEPTO, NACIONALIDAD, FECHA_NACIMIENTO, MAIL, USUARIO)
SELECT DISTINCT 5, M.Cli_Nro_Doc, M.Cli_Nombre, M.Cli_Apellido, M.Cli_Pais_Codigo, M.Cli_Dom_Calle + ' ' + CONVERT(VARCHAR(10),M.Cli_Dom_Nro), M.Cli_Dom_Piso, M.Cli_Dom_Depto, M.Cli_Pais_Codigo, M.Cli_Fecha_Nac, M.Cli_Mail, U.USU_ID FROM gd_esquema.Maestra M, BOBBY_TABLES.USUARIOS U --HARDCODEO EL PASAPORTE PARA SIMPLIFICAR LA APLICACIÓN
WHERE U.USERNAME = M.Cli_Mail

--AGREGANDO DATOS EN LA TABLA CUENTAS
SET IDENTITY_INSERT BOBBY_TABLES.CUENTAS ON

INSERT INTO BOBBY_TABLES.CUENTAS(CUE_ID, CLIENTE, PAIS, MONEDA, TIPO, FECHA_ALTA, FECHA_EXPIRACION, ESTADO)
SELECT DISTINCT M.Cuenta_Numero, C.CLI_ID, M.Cuenta_Pais_Codigo, 1, 1, M.Cuenta_Fecha_Creacion, ISNULL(M.Cuenta_Fecha_Cierre, M.Cuenta_Fecha_Creacion + T.VIGENCIA), ISNULL(M.Cuenta_Estado, 3) FROM gd_esquema.Maestra M, BOBBY_TABLES.USUARIOS U, BOBBY_TABLES.TIPOS_CUENTA T, BOBBY_TABLES.CLIENTES C
WHERE C.USUARIO = U.USU_ID AND
	  U.USERNAME = M.Cli_Mail AND
	  T.TIP_ID = 1

SET IDENTITY_INSERT BOBBY_TABLES.CUENTAS OFF

--AGREGANDO DATOS EN LA TABLA TARJETAS
INSERT INTO BOBBY_TABLES.TARJETAS(CLIENTE,ENCRIPTADO,LIMPIO,COD_SEGURIDAD,EMISOR,FECHA_EMISION,FECHA_VENCIMIENTO)
SELECT DISTINCT C.CLI_ID, BOBBY_TABLES.ENCRIPTAR_TARJETA(M.Tarjeta_Numero), BOBBY_TABLES.ULTIMOS_4_DIGITOS(M.Tarjeta_Numero), HASHBYTES('SHA1',M.Tarjeta_Codigo_Seg), E.EMI_ID, Tarjeta_Fecha_Emision, Tarjeta_Fecha_Vencimiento FROM gd_esquema.Maestra M, BOBBY_TABLES.USUARIOS U, BOBBY_TABLES.EMISORES E, BOBBY_TABLES.CLIENTES C
WHERE C.USUARIO = U.USU_ID AND
	  U.USERNAME = M.Cli_Mail AND
	  E.NOMBRE = M.Tarjeta_Emisor_Descripcion

--AGREGANDO DATOS EN LA TABLA BANCOS
SET IDENTITY_INSERT BOBBY_TABLES.BANCOS ON

INSERT INTO BOBBY_TABLES.BANCOS(BAN_ID, NOMBRE, DIRECCION)
SELECT DISTINCT Banco_Cogido, Banco_Nombre, Banco_Direccion FROM gd_esquema.Maestra
WHERE Banco_Cogido IS NOT NULL

SET IDENTITY_INSERT BOBBY_TABLES.BANCOS OFF

--AGREGANDO DATOS EN LA TABLA CHEQUES
SET IDENTITY_INSERT BOBBY_TABLES.CHEQUES ON

INSERT INTO BOBBY_TABLES.CHEQUES(CHE_ID, BANCO)
SELECT DISTINCT Cheque_Numero, Banco_Cogido FROM gd_esquema.Maestra
WHERE Cheque_Numero IS NOT NULL

SET IDENTITY_INSERT BOBBY_TABLES.CHEQUES OFF

--AGREGANDO DEPOSITOS EN LA TABLA OPERACIONES
SET IDENTITY_INSERT BOBBY_TABLES.OPERACIONES ON

INSERT INTO BOBBY_TABLES.OPERACIONES(OPE_ID, CUENTA, MONEDA, FECHA, IMPORTE)
SELECT DISTINCT Deposito_Codigo, Cuenta_Numero, 1, Deposito_Fecha, Deposito_Importe FROM gd_esquema.Maestra
WHERE Deposito_Codigo IS NOT NULL

SET IDENTITY_INSERT BOBBY_TABLES.OPERACIONES OFF

--AGREGANDO DEPOSITOS DE LA TABLA OPERACIONES EN DEPOSITOS
INSERT INTO BOBBY_TABLES.DEPOSITOS
SELECT O.OPE_ID, T.TAR_ID FROM gd_esquema.Maestra M, BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.TARJETAS T
WHERE M.Deposito_Codigo = O.OPE_ID AND
	  T.ENCRIPTADO = BOBBY_TABLES.ENCRIPTAR_TARJETA(M.Tarjeta_Numero) AND
	  T.LIMPIO = BOBBY_TABLES.ULTIMOS_4_DIGITOS(M.Tarjeta_Numero)

--AGREGANDO TRANSFERENCIAS EN LA TABLA OPERACIONES
CREATE TABLE BOBBY_TABLES.#AUXILIAR(			--SE UTILIZA PARA ASEGURAR UNICIDAD
	OPERACION INT IDENTITY(1,1),				--EN LA TABLA OPERACIONES CONTRA TRANSFERENCIAS
	CUENTA_ORIGEN NUMERIC(18,0),
	MONEDA INT,
	FECHA DATETIME,
	IMPORTE FLOAT,
	CUENTA_DESTINO NUMERIC(18,0),
	COSTO FLOAT,
	NRO_FAC NUMERIC(18,0),
	DESC_FAC VARCHAR(150),
	FECHA_FAC DATETIME,
)

INSERT INTO BOBBY_TABLES.#AUXILIAR
SELECT DISTINCT Cuenta_Numero, 1, Transf_Fecha, Trans_Importe, Cuenta_Dest_Numero, Trans_Costo_Trans, Factura_Numero, Item_Factura_Descr, Factura_Fecha FROM gd_esquema.Maestra
WHERE Trans_Importe > 0

SET IDENTITY_INSERT BOBBY_TABLES.OPERACIONES ON

INSERT INTO BOBBY_TABLES.OPERACIONES(OPE_ID, CUENTA, MONEDA, FECHA, IMPORTE)
SELECT OPERACION, CUENTA_ORIGEN, MONEDA, FECHA, IMPORTE FROM BOBBY_TABLES.#AUXILIAR

SET IDENTITY_INSERT BOBBY_TABLES.OPERACIONES OFF

--AGREGANDO TRANSFERENCIAS DE LA AUXILIAR EN TRANSFERENCIAS
INSERT INTO BOBBY_TABLES.TRANSFERENCIAS
SELECT OPERACION, CUENTA_DESTINO, COSTO FROM BOBBY_TABLES.#AUXILIAR

--AGREGANDO LAS FACTURAS POR TRANSFERENCIAS A LA TABLA FACTURAS
SET IDENTITY_INSERT BOBBY_TABLES.FACTURAS ON

INSERT INTO BOBBY_TABLES.FACTURAS(FAC_NRO, PAGADO)
SELECT NRO_FAC, 1 FROM BOBBY_TABLES.#AUXILIAR
WHERE NRO_FAC IS NOT NULL

SET IDENTITY_INSERT BOBBY_TABLES.FACTURAS OFF

INSERT INTO BOBBY_TABLES.COMISIONES(DESCRIPCION, OPERACION, IMPORTE, FECHA, FACTURA)
SELECT DESC_FAC, OPERACION, IMPORTE, FECHA_FAC, NRO_FAC FROM BOBBY_TABLES.#AUXILIAR
WHERE NRO_FAC IS NOT NULL

DROP TABLE BOBBY_TABLES.#AUXILIAR --ELIMINO LA TABLA TEMPORAL

--AGREGANDO RETIROS DE EFECTIVO EN LA TABLA OPERACIONES
SET IDENTITY_INSERT BOBBY_TABLES.OPERACIONES ON

INSERT INTO BOBBY_TABLES.OPERACIONES(OPE_ID, CUENTA, MONEDA, FECHA, IMPORTE)
SELECT DISTINCT Retiro_Codigo, Cuenta_Numero, 1, Retiro_Fecha, Retiro_Importe FROM gd_esquema.Maestra
WHERE Retiro_Codigo IS NOT NULL AND
	  Retiro_Importe > 0
	  
SET IDENTITY_INSERT BOBBY_TABLES.OPERACIONES OFF
	  
--AGREGANDO RETIROS DE EFECTIVO DE LA TABLA OPERACIONES EN LA TABLA RETIROS_EFECTIVO
INSERT INTO BOBBY_TABLES.RETIROS_EFECTIVO
SELECT O.OPE_ID, C.CHE_ID FROM gd_esquema.Maestra M, BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.CHEQUES C
WHERE M.Retiro_Codigo = O.OPE_ID AND
	  C.CHE_ID = M.Cheque_Numero

-------------------------------------------
------PROCEDURES PARA LA APLICACIÓN--------
-------------------------------------------

------------------------------------------------------------------------------------
------------------------------------LOGIN-------------------------------------------
------------------------------------------------------------------------------------
GO
CREATE PROCEDURE BOBBY_TABLES.EXISTE_USUARIO(@USUARIO VARCHAR(255)) AS
BEGIN
	DECLARE @CANTIDAD INT
	
	SELECT @CANTIDAD = COUNT(USERNAME) FROM BOBBY_TABLES.USUARIOS
	WHERE USERNAME = @USUARIO AND
		  ESTADO = 1
	
	RETURN @CANTIDAD
END


GO
CREATE PROCEDURE BOBBY_TABLES.PASSWORD_CORRECTA(@USUARIO VARCHAR(255),@PASSWORD VARCHAR(64)) AS
BEGIN
	DECLARE @HASH_PASS VARBINARY(32), @CANTIDAD INT
	SET @HASH_PASS = CONVERT(VARBINARY(32), @PASSWORD, 2)

	SELECT @CANTIDAD = COUNT(USERNAME) FROM BOBBY_TABLES.USUARIOS
	WHERE ESTADO = 1 AND
		  USERNAME = @USUARIO AND
		  PASSWORD = @HASH_PASS

	RETURN @CANTIDAD
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_PREGUNTA(@USUARIO VARCHAR(255)) AS
BEGIN
	SELECT PREGUNTA_SECRETA FROM BOBBY_TABLES.USUARIOS
	WHERE USERNAME = @USUARIO
END

GO
CREATE PROCEDURE BOBBY_TABLES.RESPUESTA_CORRECTA(@USUARIO VARCHAR(255),@RESPUESTA VARCHAR(64)) AS
BEGIN
	DECLARE @HASH_RESP VARBINARY(32), @CANTIDAD INT
	SET @HASH_RESP = CONVERT(VARBINARY(32), @RESPUESTA, 2)

	SELECT @CANTIDAD = COUNT(USERNAME) FROM BOBBY_TABLES.USUARIOS
	WHERE ESTADO = 1 AND
		  USERNAME = @USUARIO AND
		  RESPUESTA = @HASH_RESP

	RETURN @CANTIDAD
END

GO
CREATE PROCEDURE BOBBY_TABLES.SET_PASSWORD(@USUARIO VARCHAR(255),@PASSWORD VARCHAR(64)) AS
BEGIN --TRANSACTION
	DECLARE @HASH_PASS VARBINARY(32)
	SET @HASH_PASS = CONVERT(VARBINARY(32), @PASSWORD, 2)
	
	UPDATE BOBBY_TABLES.USUARIOS SET
		PASSWORD = @HASH_PASS
	WHERE USERNAME = @USUARIO
END --COMMIT

GO
CREATE TRIGGER BOBBY_TABLES.AFTER_LOGIN ON BOBBY_TABLES.INTENTOS_LOGIN AFTER INSERT AS
BEGIN --TRANSACTION
	DECLARE @ACCESO INT, @USU_ID INT, @ESTADO INT, @INTENTOS_FALLIDOS_ACTUAL INT
	SELECT @ACCESO = ACCESO, @USU_ID = USUARIO FROM INSERTED
	
	SELECT @ESTADO = ESTADO, @INTENTOS_FALLIDOS_ACTUAL = INTENTOS_FALLIDOS FROM BOBBY_TABLES.USUARIOS
	WHERE USU_ID = @USU_ID
	
	IF @ACCESO = 1
	BEGIN
		UPDATE BOBBY_TABLES.USUARIOS SET
			INTENTOS_FALLIDOS = 0
		WHERE USU_ID = @USU_ID
	END
	ELSE
	BEGIN
		IF @INTENTOS_FALLIDOS_ACTUAL = 2
		UPDATE BOBBY_TABLES.USUARIOS SET
			INTENTOS_FALLIDOS = INTENTOS_FALLIDOS + 1,
			ESTADO = 0
		WHERE USU_ID = @USU_ID
		ELSE
		UPDATE BOBBY_TABLES.USUARIOS SET
			INTENTOS_FALLIDOS = INTENTOS_FALLIDOS + 1,
			ESTADO = @ESTADO
		WHERE USU_ID = @USU_ID
	END
END --COMMIT

GO
CREATE PROCEDURE BOBBY_TABLES.INTENTO_LOGIN(@USUARIO VARCHAR(255),@ACCESO INT,@FECHA_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @FECHA DATETIME
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	INSERT INTO BOBBY_TABLES.INTENTOS_LOGIN
	SELECT USU_ID, @FECHA, @ACCESO FROM BOBBY_TABLES.USUARIOS
	WHERE USERNAME = @USUARIO
END --COMMIT

GO
CREATE PROCEDURE BOBBY_TABLES.GET_ROLES_USUARIO(@USUARIO VARCHAR(255)) AS
BEGIN
	SELECT ROL_ID, NOMBRE FROM BOBBY_TABLES.USUARIOS U, BOBBY_TABLES.ROLES_POR_USUARIO, BOBBY_TABLES.ROLES R
	WHERE USERNAME = @USUARIO AND
		  USU_ID  = USUARIO AND
		  ROL_ID = ROL AND
		  R.ESTADO = 1 AND
		  U.ESTADO = 1
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_CUENTAS_USUARIO(@USUARIO INT) AS
BEGIN
	SELECT CUE_ID FROM BOBBY_TABLES.CUENTAS, BOBBY_TABLES.USUARIOS, BOBBY_TABLES.CLIENTES
	WHERE USU_ID = @USUARIO AND
		  USUARIO = USU_ID AND
		  CLIENTE = CLI_ID
END

--GET MONEDAS
GO
CREATE PROCEDURE BOBBY_TABLES.GET_MONEDAS AS
BEGIN
	SELECT MON_ID, NOMBRE FROM BOBBY_TABLES.MONEDAS
END

--GET BANCOS
GO
CREATE PROCEDURE BOBBY_TABLES.GET_BANCOS AS
BEGIN
	SELECT BAN_ID, NOMBRE FROM BOBBY_TABLES.BANCOS
END

--GET PAISES
GO
CREATE PROCEDURE BOBBY_TABLES.GET_PAISES AS
BEGIN
	SELECT PAI_ID, NOMBRE FROM BOBBY_TABLES.PAISES
	ORDER BY NOMBRE
END
------------------------------------------------------------------------------------
----------------------------------GETS_BY_STRING------------------------------------
------------------------------------------------------------------------------------
--GET USUARIO
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ID_USUARIO(@USUARIO VARCHAR(255)) AS
BEGIN
	DECLARE @USU_ID INT
	
	SELECT @USU_ID = USU_ID FROM BOBBY_TABLES.USUARIOS
	WHERE USERNAME = @USUARIO
	
	RETURN @USU_ID
END
--GET PAIS
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ID_PAIS(@PAIS VARCHAR(250)) AS
BEGIN --TRANSACTION
	DECLARE @PAIS_ID INT
	
	SELECT @PAIS_ID = PAI_ID FROM BOBBY_TABLES.PAISES
	WHERE @PAIS = NOMBRE
	
	IF @PAIS_ID IS NULL
	BEGIN
		INSERT INTO BOBBY_TABLES.PAISES
		VALUES(@PAIS)
		SET @PAIS_ID = @@IDENTITY
	END
	
	RETURN @PAIS_ID
END --COMMIT

--GET EMISOR
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ID_EMISOR(@EMISOR VARCHAR(60)) AS
BEGIN --TRANSACTION
	DECLARE @EMISOR_ID INT
	
	SELECT @EMISOR_ID = EMI_ID FROM EMISORES
	WHERE NOMBRE = @EMISOR

	IF @EMISOR_ID IS NULL --SI EL EMISOR NO EXISTE, SE AGREGA A LA BASE
	BEGIN
		INSERT INTO BOBBY_TABLES.EMISORES
		VALUES(@EMISOR)
		SET @EMISOR_ID = @@IDENTITY
	END
	
	RETURN @EMISOR_ID
END --COMMIT

--GET BANCO
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ID_BANCO(@BANCO VARCHAR(50)) AS
BEGIN --TRANSACTION
	DECLARE @BANCO_ID INT
	
	SELECT @BANCO_ID = BAN_ID FROM BANCOS
	WHERE NOMBRE = @BANCO

	IF @BANCO_ID IS NULL --SI EL EMISOR NO EXISTE, SE AGREGA A LA BASE
	BEGIN
		INSERT INTO BOBBY_TABLES.BANCOS
		VALUES(@BANCO, NULL)
		SET @BANCO_ID = @@IDENTITY
	END
	
	RETURN @BANCO_ID
END --COMMIT

------------------------------------------------------------------------------------
------------------------------CLIENTES Y USUARIOS-----------------------------------
------------------------------------------------------------------------------------

--ALTA CLIENTES
GO
CREATE PROCEDURE BOBBY_TABLES.AGREGAR_CLIENTE(@NOMBRE VARCHAR(255),@APELLIDO VARCHAR(255),@DOC VARCHAR(10),
	@TIPO_DOC INT,@CALLE VARCHAR(255),@PISO INT,@DEPTO VARCHAR(10),@LOCALIDAD VARCHAR(60),
	@PAIS VARCHAR(250),@FECHA_NAC_APP VARCHAR(30),@NACIONALIDAD VARCHAR(250),@MAIL VARCHAR(255),@USERNAME VARCHAR(40),@PASSWORD_APP VARCHAR(64),
	@FECHA_ALTA_APP VARCHAR(30),@PREGUNTA VARCHAR(100),@RESPUESTA_APP VARCHAR(64)) AS
BEGIN --TRANSACTION
	DECLARE @FECHA_NAC DATETIME, @FECHA_ALTA DATETIME, @PASSWORD VARBINARY(32), @RESPUESTA VARBINARY(32), @PAIS_ID INT, @NAC_ID INT, @USU_ID INT
	SET @FECHA_NAC = CONVERT(DATETIME, @FECHA_NAC_APP)
	SET @FECHA_ALTA = CONVERT(DATETIME, @FECHA_ALTA_APP)
	SET @PASSWORD = CONVERT(VARBINARY(32), @PASSWORD_APP, 2)
	SET @RESPUESTA = CONVERT(VARBINARY(32), @RESPUESTA_APP, 2)
	
	EXEC @PAIS_ID = BOBBY_TABLES.GET_ID_PAIS
				@PAIS = @PAIS

	EXEC @NAC_ID = BOBBY_TABLES.GET_ID_PAIS
				@PAIS = @NACIONALIDAD
					
	INSERT INTO BOBBY_TABLES.USUARIOS(USERNAME, PASSWORD, FECHA_ALTA, PREGUNTA_SECRETA, RESPUESTA)
	VALUES(@USERNAME, @PASSWORD, @FECHA_ALTA, @PREGUNTA, @RESPUESTA)

	SET @USU_ID = @@IDENTITY

	INSERT INTO ROLES_POR_USUARIO
	VALUES(2, @USU_ID)
				
	INSERT INTO BOBBY_TABLES.CLIENTES(TIPO_DOC,NUMERO_DOC,NOMBRE,APELLIDO,PAIS,CALLE,PISO,DEPTO,LOCALIDAD,NACIONALIDAD,FECHA_NACIMIENTO,MAIL,USUARIO)
	VALUES(@TIPO_DOC, @DOC, @NOMBRE, @APELLIDO, @PAIS_ID, @CALLE, @PISO, @DEPTO, @LOCALIDAD, @NAC_ID, @FECHA_NAC, @MAIL, @USU_ID)

	RETURN @@IDENTITY
END --COMMIT

--MODIFICACIÓN CLIENTES
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_CLIENTE(@ID INT,@NOMBRE VARCHAR(255),@APELLIDO VARCHAR(255),
	@DOC VARCHAR(10),@TIPO_DOC INT,@CALLE VARCHAR(255),@PISO INT,@DEPTO VARCHAR(10),
	@LOCALIDAD VARCHAR(60),@PAIS VARCHAR(250),@FECHA_NAC_APP VARCHAR(30),@NACIONALIDAD VARCHAR(250),@MAIL VARCHAR(255)) AS
BEGIN --TRANSACTION
	DECLARE @USUARIO INT, @PAIS_ID INT, @NAC_ID INT, @FECHA_NAC DATETIME, @FECHA_MOD DATETIME
	SET @FECHA_NAC = CONVERT(DATETIME, @FECHA_NAC_APP)
	
	SELECT @USUARIO = USUARIO FROM BOBBY_TABLES.CLIENTES WHERE CLI_ID = @ID
	
	EXEC @PAIS_ID = BOBBY_TABLES.GET_ID_PAIS
				@PAIS = @PAIS
				
	EXEC @NAC_ID = BOBBY_TABLES.GET_ID_PAIS
				@PAIS = @NACIONALIDAD
	
	UPDATE BOBBY_TABLES.CLIENTES SET
		NOMBRE = @NOMBRE,
		APELLIDO = @APELLIDO,
		NUMERO_DOC = @DOC,
		TIPO_DOC = @TIPO_DOC,
		CALLE = @CALLE,
		PISO = @PISO,
		DEPTO = @DEPTO,
		LOCALIDAD = @LOCALIDAD,
		PAIS = @PAIS_ID,
		FECHA_NACIMIENTO = @FECHA_NAC,
		NACIONALIDAD = @NAC_ID,
		MAIL = @MAIL
	WHERE CLI_ID = @ID
END --COMMIT

--BAJA CLIENTES
GO
CREATE PROCEDURE BOBBY_TABLES.BAJA_CLIENTE(@ID INT) AS --TODO ¿DAR DE BAJA USUARIO Y/O PERSONA?
BEGIN --TRANSAC
	UPDATE BOBBY_TABLES.CLIENTES SET
	ESTADO = 0
	WHERE CLI_ID = @ID
END --COMMIT

--GET CUENTA
GO
CREATE PROCEDURE BOBBY_TABLES.GET_CUENTA(@ID NUMERIC(18,0)) AS
BEGIN
	SELECT C.*, P.NOMBRE AS PAI_NOM, M.NOMBRE AS MON_NOM, T.NOMBRE AS TIP_NOM FROM BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.PAISES P, BOBBY_TABLES.MONEDAS M, BOBBY_TABLES.TIPOS_CUENTA T
	WHERE CUE_ID = @ID AND
		  PAIS = PAI_ID AND
		  MONEDA = MON_ID AND
		  TIPO = TIP_ID
END


--GET CLIENTES
GO
CREATE PROCEDURE BOBBY_TABLES.GET_CLIENTE(@ID INT) AS
BEGIN
	SELECT * FROM BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.USUARIOS U
	WHERE P.CLI_ID = @ID AND U.USU_ID = P.USUARIO
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_CLIENTE_DNI(@DOC NUMERIC(10,0),@TIPO INT) AS
BEGIN
	SELECT CLI_ID
	FROM BOBBY_TABLES.CLIENTES
	WHERE @TIPO = TIPO_DOC AND @DOC = NUMERO_DOC
END


GO
CREATE PROCEDURE BOBBY_TABLES.GET_CLIENTE_MAIL(@MAIL VARCHAR(255)) AS
BEGIN
	SELECT CLI_ID
	FROM BOBBY_TABLES.CLIENTES
	WHERE MAIL = @MAIL
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_TARJETAS_CLIENTE(@ID INT) AS
BEGIN
	SELECT TAR_ID, CLIENTE, NOMBRE, '************' + LIMPIO AS NUMERO_TARJETA FROM BOBBY_TABLES.TARJETAS, BOBBY_TABLES.EMISORES
	WHERE @ID = CLIENTE AND
		  EMISOR = EMI_ID
	RETURN
END

--MODIFICACIÓN CONTRASEÑA
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_CONTRASENIA(@USUARIO INT, @PASSWORD_APP VARCHAR(64)) AS
BEGIN --TRANSACTION
	DECLARE @PASSWORD VARBINARY(32)
	SET @PASSWORD = CONVERT(VARBINARY(32), @PASSWORD_APP, 2)
	
	UPDATE BOBBY_TABLES.USUARIOS SET
		PASSWORD = @PASSWORD
	WHERE @USUARIO = USU_ID
END --COMMIT

------------------------------------------------------------------------------------
--------------------------------------CUENTAS---------------------------------------
------------------------------------------------------------------------------------

--ALTA CUENTAS
GO
CREATE PROCEDURE BOBBY_TABLES.AGREGAR_CUENTA(@CLIENTE INT,@MONEDA INT,@PAIS VARCHAR(250),@TIPO INT,
	@FECHA_ALTA_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @PAIS_ID INT, @FECHA_ALTA DATETIME, @CUENTA NUMERIC(18,0), @VIGENCIA INT, @IMPORTE FLOAT
	SET @FECHA_ALTA = CONVERT(DATETIME, @FECHA_ALTA_APP)
	
	EXEC @PAIS_ID = BOBBY_TABLES.GET_ID_PAIS
				@PAIS = @PAIS
	
	SELECT @IMPORTE = COSTO_MANTENIMIENTO, @VIGENCIA = VIGENCIA FROM BOBBY_TABLES.TIPOS_CUENTA
	WHERE TIP_ID = @TIPO
	INSERT INTO BOBBY_TABLES.CUENTAS(CLIENTE, PAIS, MONEDA, TIPO, FECHA_ALTA, FECHA_EXPIRACION, ESTADO)
	VALUES(@CLIENTE, @PAIS_ID, @MONEDA, @TIPO, @FECHA_ALTA, @FECHA_ALTA + @VIGENCIA, 3) --ESTADO PENDIENTE DE ACTIVACIÓN
	
	SET @CUENTA = @@IDENTITY
	
	INSERT INTO BOBBY_TABLES.COMISIONES(DESCRIPCION, CUENTA, TIPO_CUENTA, IMPORTE, FECHA)
	VALUES('Apertura de cuenta', @CUENTA, @TIPO, @IMPORTE, @FECHA_ALTA)
END --COMMIT

--MODIFICACIÓN CUENTAS
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_CUENTA(@ID NUMERIC(18,0),@CLIENTE INT,@MONEDA INT,@PAIS VARCHAR(250),
	@TIPO INT,@ESTADO INT,@FECHA_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @TIPO_ANTERIOR INT, @FECHA DATETIME
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	SELECT @TIPO_ANTERIOR = TIPO FROM BOBBY_TABLES.CUENTAS
	WHERE CUE_ID = @ID
	
	DECLARE @PAIS_ID INT
	
	EXEC @PAIS_ID = BOBBY_TABLES.GET_ID_PAIS
				@PAIS = @PAIS
	
	UPDATE BOBBY_TABLES.CUENTAS SET
			CLIENTE = @CLIENTE,
			MONEDA = @MONEDA,
			PAIS = @PAIS,
			TIPO = @TIPO,
			ESTADO = @ESTADO
		WHERE CUE_ID = @ID
		
	IF @TIPO_ANTERIOR != @TIPO --SE CREA LA COMISION Y SE ACTUALIZA LA FECHA DE VIGENCIA SI EL TIPO DE CUENTA ESTÁ SIENDO CAMBIADO
		BEGIN
		DECLARE @VIGENCIA INT, @IMPORTE FLOAT
		SELECT @VIGENCIA = VIGENCIA, @IMPORTE = COSTO_MANTENIMIENTO FROM BOBBY_TABLES.TIPOS_CUENTA
		WHERE TIP_ID = @TIPO
		
		UPDATE BOBBY_TABLES.CUENTAS SET
			FECHA_EXPIRACION = @FECHA + @VIGENCIA
		WHERE CUE_ID = @ID
		
		INSERT INTO BOBBY_TABLES.COMISIONES(DESCRIPCION, CUENTA, TIPO_CUENTA, IMPORTE, FECHA)
		VALUES('Cambio de tipo de cuenta', @ID, @TIPO, @IMPORTE, @FECHA)
		END
END --COMMIT

--BAJA CUENTAS
GO
CREATE PROCEDURE BOBBY_TABLES.BAJA_CUENTA(@ID NUMERIC(18,0), @FECHA_CIERRE_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @FECHA_CIERRE DATETIME
	SET @FECHA_CIERRE = CONVERT(DATETIME, @FECHA_CIERRE_APP)
	
	UPDATE BOBBY_TABLES.CUENTAS SET
		ESTADO = 4,
		FECHA_CIERRE = @FECHA_CIERRE
	WHERE CUE_ID = @ID
END --COMMIT

GO
CREATE PROCEDURE BOBBY_TABLES.FIND_CLIENTES(@NOMBRE VARCHAR(255) = NULL,@APELLIDO VARCHAR(255) = NULL, 
	@MAIL VARCHAR(255) = NULL,@TIPODOC INT,@DOC VARCHAR(10) = NULL) AS
BEGIN
	SELECT * FROM BOBBY_TABLES.CLIENTES
	WHERE (@NOMBRE IS NULL OR NOMBRE LIKE '%' + @NOMBRE + '%') AND
		  (@APELLIDO IS NULL OR APELLIDO LIKE '%' + @APELLIDO + '%') AND
		  (@MAIL IS NULL OR MAIL LIKE '%' + @MAIL + '%') AND
		  (@TIPODOC = 0 OR TIPO_DOC = @TIPODOC) AND
		  (@DOC IS NULL OR NUMERO_DOC LIKE '%' + @DOC + '%')
END

--FIND CUENTAS
GO
CREATE PROCEDURE BOBBY_TABLES.FIND_CUENTAS(@NUMERO VARCHAR(16) = NULL, @PAIS VARCHAR(50) = NULL,
	@TIPO INT = NULL, @VAR INT) AS
BEGIN
	SELECT C.* FROM BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.PAISES P
	WHERE  C.PAIS = P.PAI_ID AND
		  (@NUMERO IS NULL OR CUE_ID LIKE '%' + @NUMERO + '%') AND
		  (@PAIS IS NULL OR NOMBRE LIKE '%' + @PAIS + '%') AND
		  (@TIPO = 0 OR TIPO = @TIPO) AND
		  (@VAR = 0 OR ESTADO != 4)
END

--GET SALDO
GO
CREATE PROCEDURE BOBBY_TABLES.GET_SALDO(@CUENTA NUMERIC(18,0)) AS
BEGIN
	SELECT SALDO FROM BOBBY_TABLES.CUENTAS
	WHERE CUE_ID = @CUENTA
END

--GET ESTADOS
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ESTADOS AS
BEGIN
	SELECT EST_ID, NOMBRE FROM BOBBY_TABLES.ESTADOS_CUENTA
END


--GET TIPOS CUENTA
GO
CREATE PROCEDURE BOBBY_TABLES.GET_TIPOS_CUENTA AS
BEGIN
	SELECT TIP_ID, NOMBRE FROM BOBBY_TABLES.TIPOS_CUENTA
END
--MODIFICACIÓN DE TIPO DE CUENTA
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_TIPO_CUENTA(@CUENTA NUMERIC(18,0),@TIPO INT,@FECHA_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @FECHA DATETIME
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	DECLARE @VIGENCIA INT, @IMPORTE FLOAT
	SELECT @VIGENCIA = VIGENCIA, @IMPORTE = COSTO_MANTENIMIENTO FROM BOBBY_TABLES.TIPOS_CUENTA
	WHERE TIP_ID = @TIPO
		
	UPDATE BOBBY_TABLES.CUENTAS SET
		FECHA_EXPIRACION = @FECHA + @VIGENCIA,
		TIPO = @TIPO
	WHERE CUE_ID = @CUENTA
		
	INSERT INTO BOBBY_TABLES.COMISIONES(DESCRIPCION, CUENTA, TIPO_CUENTA, IMPORTE, FECHA)
	VALUES('Cambio de tipo de cuenta', @CUENTA, @TIPO, @IMPORTE, @FECHA)
END --COMMIT


GO
CREATE PROCEDURE BOBBY_TABLES.GET_COSTOS_TIPO(@ID INT) AS
BEGIN
	SELECT COSTO_MANTENIMIENTO, COSTO_TRANSACCION, VIGENCIA FROM BOBBY_TABLES.TIPOS_CUENTA
	WHERE TIP_ID = @ID
END


--MODIFICACIÓN DE COSTOS Y VIGENCIA DE TIPOS CUENTA
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_COSTOS_TIPO(@ID INT,@COSTO_MANTENIMIENTO FLOAT,@COSTO_TRANSFERENCIA FLOAT,
	@VIGENCIA INT) AS
BEGIN --TRANSACTION
	UPDATE BOBBY_TABLES.TIPOS_CUENTA SET
		COSTO_MANTENIMIENTO = @COSTO_MANTENIMIENTO,
		COSTO_TRANSACCION = @COSTO_TRANSFERENCIA,
		VIGENCIA = @VIGENCIA
	WHERE TIP_ID = @ID
END --COMMIT
GO

------------------------------------------------------------------------------------
--------------------------------------ROLES-----------------------------------------
------------------------------------------------------------------------------------

--TIPO DE LISTA_INT PARA FUNCIONALIDADES
CREATE TYPE BOBBY_TABLES.LISTA_INT AS TABLE(
	ITEM INT
)

--ALTA ROLES
GO
CREATE PROCEDURE BOBBY_TABLES.AGREGAR_ROL(@NOMBRE VARCHAR(50), @FUNCIONALIDADES AS BOBBY_TABLES.LISTA_INT READONLY) AS
BEGIN --TRANSACTION
	DECLARE @ID_ROL INT
	
	INSERT INTO BOBBY_TABLES.ROLES(NOMBRE)
	VALUES(@NOMBRE)
	
	SET @ID_ROL = @@IDENTITY
	
	INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
	SELECT ITEM, @ID_ROL FROM @FUNCIONALIDADES
END --COMMIT

--MODIFICACIÓN ROLES
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_ROL(@ID INT, @NOMBRE VARCHAR(50), @FUNCIONALIDADES AS BOBBY_TABLES.LISTA_INT READONLY) AS
BEGIN --TRANSACTION
	UPDATE BOBBY_TABLES.ROLES SET
		NOMBRE = @NOMBRE
	WHERE ROL_ID = @ID
	
	DELETE FROM BOBBY_TABLES.FUNCIONALIDADES_POR_ROL --SE BORRAN TODAS LAS FUNCIONALIDADES ANTERIORES
	WHERE ROL = @ID
	
	INSERT INTO BOBBY_TABLES.FUNCIONALIDADES_POR_ROL --SE INGRESAN LAS FUNCIONALIDADES MODIFICADAS COMO SI FUERAN NUEVAS
	SELECT ITEM, @ID FROM @FUNCIONALIDADES
END --COMMIT

--BAJA ROLES
GO
CREATE PROCEDURE BOBBY_TABLES.BAJA_ROL(@ID INT) AS
BEGIN --TRANSACTION
	UPDATE BOBBY_TABLES.ROLES SET
		ESTADO = 0
	WHERE ROL_ID = @ID
END --COMMIT

--ACTIVAR ROLES
GO
CREATE PROCEDURE BOBBY_TABLES.ACTIVAR_ROL(@NOMBRE VARCHAR(50)) AS
BEGIN --TRANSACTION
	UPDATE BOBBY_TABLES.ROLES SET
		ESTADO = 1
	WHERE NOMBRE = @NOMBRE
END --COMMIT

--GET ROLES
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ROL(@ID INT) AS
BEGIN
	SELECT ROL_ID, NOMBRE, FUNCIONALIDAD FROM BOBBY_TABLES.ROLES, BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
	WHERE ROL_ID = @ID AND
		  ROL_ID = ROL
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_ROL_NOM(@NOMBRE VARCHAR(50)) AS
BEGIN
	SELECT ROL_ID, NOMBRE FROM BOBBY_TABLES.ROLES
	WHERE NOMBRE = @NOMBRE
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_ROLES AS
BEGIN
	SELECT ROL_ID AS Indice, NOMBRE AS Rol FROM BOBBY_TABLES.ROLES
	WHERE ESTADO = 1
END

--GET FUNCIONALIDADES
GO
CREATE PROCEDURE BOBBY_TABLES.GET_FUNCIONALIDADES AS
BEGIN
	SELECT FUN_ID, NOMBRE FROM BOBBY_TABLES.FUNCIONALIDADES
END

--GET FUNCIONALIDADES POR ROL ID
GO
CREATE PROCEDURE BOBBY_TABLES.GET_FUNCIONALIDADES_ROL(@ROL_ID INT) AS
BEGIN
	SELECT FUNCIONALIDAD FROM BOBBY_TABLES.FUNCIONALIDADES_POR_ROL
	WHERE ROL = @ROL_ID
END

------------------------------------------------------------------------------------
--------------------------------------TARJETAS--------------------------------------
------------------------------------------------------------------------------------
--ASOCIACIÓN TARJETAS
GO
CREATE PROCEDURE BOBBY_TABLES.ASOCIAR_TARJETA(@NUMERO NUMERIC(16,0),@CLIENTE INT,@CODIGO_SEG NUMERIC(4,0),
	@EMISOR VARCHAR(60),@FECHA_EMISION_APP VARCHAR(30),@FECHA_VENCIMIENTO_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @EMISOR_ID INT, @FECHA_EMISION DATETIME, @FECHA_VENCIMIENTO DATETIME
	SET @FECHA_EMISION = CONVERT(DATETIME, @FECHA_EMISION_APP)
	SET @FECHA_VENCIMIENTO = CONVERT(DATETIME, @FECHA_VENCIMIENTO_APP)
	
	EXEC @EMISOR_ID = BOBBY_TABLES.GET_ID_EMISOR
						@EMISOR = @EMISOR
	
	INSERT INTO BOBBY_TABLES.TARJETAS(CLIENTE,ENCRIPTADO,LIMPIO,COD_SEGURIDAD,EMISOR,FECHA_EMISION,FECHA_VENCIMIENTO)
	VALUES(@CLIENTE, BOBBY_TABLES.ENCRIPTAR_TARJETA(@NUMERO), BOBBY_TABLES.ULTIMOS_4_DIGITOS(@NUMERO), HASHBYTES('SHA1',CONVERT(VARCHAR(4),@CODIGO_SEG)), @EMISOR_ID, @FECHA_EMISION, @FECHA_VENCIMIENTO + 1095)
END --COMMIT

--MODIFICIÓN TARJETAS
GO
CREATE PROCEDURE BOBBY_TABLES.MODIFICAR_TARJETA(@ID INT,@NUMERO NUMERIC(16,0),@CLIENTE INT,@CODIGO_SEG NUMERIC(4,0),
	@EMISOR VARCHAR(60),@FECHA_EMISION_APP VARCHAR(30),@FECHA_VENCIMIENTO_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @EMISOR_ID INT, @FECHA_EMISION DATETIME, @FECHA_VENCIMIENTO DATETIME
	SET @FECHA_EMISION = CONVERT(DATETIME, @FECHA_EMISION_APP)
	SET @FECHA_VENCIMIENTO = CONVERT(DATETIME, @FECHA_VENCIMIENTO_APP)
	
	EXEC @EMISOR_ID = BOBBY_TABLES.GET_ID_EMISOR
						@EMISOR = @EMISOR
	
	UPDATE BOBBY_TABLES.TARJETAS SET
		CLIENTE = @CLIENTE,
		ENCRIPTADO = BOBBY_TABLES.ENCRIPTAR_TARJETA(@NUMERO),
		LIMPIO = BOBBY_TABLES.ULTIMOS_4_DIGITOS(@NUMERO),
		COD_SEGURIDAD = HASHBYTES('SHA1',CONVERT(VARCHAR(4),@CODIGO_SEG)),
		EMISOR = @EMISOR_ID,
		FECHA_EMISION = @FECHA_EMISION,
		FECHA_VENCIMIENTO = @FECHA_VENCIMIENTO
	WHERE TAR_ID = @ID
END --COMMIT

--DESASOCIACIÓN TARJETAS
GO
CREATE PROCEDURE BOBBY_TABLES.DESASOCIAR_TARJETA(@ID INT) AS
BEGIN --TRANSACTION
	DELETE FROM BOBBY_TABLES.TARJETAS
	WHERE TAR_ID = @ID
END --COMMIT

--GET TARJETAS
GO
CREATE PROCEDURE BOBBY_TABLES.GET_TARJETA(@ID INT) AS
BEGIN
	SELECT * FROM BOBBY_TABLES.TARJETAS
	WHERE TAR_ID = @ID
END

--GET ID TARJETAS
GO
CREATE PROCEDURE BOBBY_TABLES.GET_ID_TARJETA(@ENCRIPT VARCHAR(40),@ULTIMOS VARCHAR(4),@COD_SEG VARCHAR(40),@FECHA_APP VARCHAR(30),@USER INT) AS
BEGIN
	DECLARE @ID INT, @HASH_ENC VARBINARY(20), @HASH_COD VARBINARY(20), @LIMPIO NUMERIC(4,0), @FECHA DATETIME
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	SET @HASH_ENC = CONVERT(VARBINARY(20), @ENCRIPT, 2)
	SET @HASH_COD = CONVERT(VARBINARY(20), @COD_SEG, 2)
	SET @LIMPIO = CONVERT(NUMERIC(4,0), @ULTIMOS)
	
	SELECT @ID = TAR_ID FROM BOBBY_TABLES.TARJETAS, BOBBY_TABLES.CLIENTES
	WHERE USUARIO = @USER AND
		  CLIENTE = CLI_ID AND
		  ENCRIPTADO = @HASH_ENC AND
		  LIMPIO = @LIMPIO AND
		  COD_SEGURIDAD = @HASH_COD AND
		  FECHA_VENCIMIENTO > @FECHA
	
	RETURN @ID
END

GO
CREATE PROCEDURE BOBBY_TABLES.GET_TARJETAS(@USER INT, @FECHA_APP VARCHAR(30)) AS
BEGIN
	DECLARE @FECHA DATETIME
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	SELECT TAR_ID, '************' + LIMPIO AS NUMERO FROM BOBBY_TABLES.TARJETAS, BOBBY_TABLES.CLIENTES
	WHERE USUARIO = @USER AND
		  CLIENTE = CLI_ID AND
		  FECHA_VENCIMIENTO >= @FECHA
END
------------------------------------------------------------------------------------
-----------------------------------OPERACIONES--------------------------------------
------------------------------------------------------------------------------------

--DEPÓSITO
GO
CREATE PROCEDURE BOBBY_TABLES.DEPOSITAR(@CUENTA NUMERIC(18,0),@TARJETA INT,@IMPORTE FLOAT,
	@MONEDA INT,@FECHA_APP VARCHAR(30)) AS
BEGIN --TRANSACTION
	DECLARE @FECHA DATETIME
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	INSERT INTO BOBBY_TABLES.OPERACIONES
	VALUES(@CUENTA, @MONEDA, @FECHA, @IMPORTE)
	
	INSERT INTO BOBBY_TABLES.DEPOSITOS
	VALUES(@@IDENTITY, @TARJETA)
	
	UPDATE BOBBY_TABLES.CUENTAS SET
		SALDO = SALDO + @IMPORTE
	WHERE CUE_ID = @CUENTA
END --COMMIT

--RETIRO DE EFECTIVO
GO
CREATE PROCEDURE BOBBY_TABLES.RETIRAR_EFECTIVO(@CUENTA NUMERIC(18,0),@FECHA_APP VARCHAR(30),
	@IMPORTE FLOAT,@MONEDA INT,@BANCO VARCHAR(50)) AS
BEGIN --TRANSACTION
	DECLARE @BANCO_ID INT, @FECHA DATETIME, @CHEQUE INT
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	EXEC @BANCO_ID = BOBBY_TABLES.GET_ID_BANCO
					@BANCO = @BANCO
	
	INSERT INTO BOBBY_TABLES.CHEQUES
	VALUES(@BANCO_ID)
	
	SET @CHEQUE = @@IDENTITY
	
	INSERT INTO BOBBY_TABLES.OPERACIONES
	VALUES(@CUENTA, @MONEDA, @FECHA, @IMPORTE)
	
	INSERT INTO BOBBY_TABLES.RETIROS_EFECTIVO
	VALUES(@@IDENTITY, @CHEQUE)
	
	UPDATE BOBBY_TABLES.CUENTAS SET
		SALDO = SALDO - @IMPORTE
	WHERE CUE_ID = @CUENTA
	
	RETURN @CHEQUE
END --COMMIT

--TRANSFERENCIA
--PROCEDIMIENTO
GO
CREATE PROCEDURE BOBBY_TABLES.TRANSFERIR(@ORIGEN NUMERIC(18,0),@DESTINO NUMERIC(18,0),
	@FECHA_APP VARCHAR(30),@IMPORTE FLOAT,@MONEDA INT) AS
BEGIN --TRANSACTION
	DECLARE @FECHA DATETIME, @COSTO_TRANSF FLOAT, @TIPO_CUENTA INT, @OPERACION NUMERIC(18,0)
	SET @FECHA = CONVERT(DATETIME, @FECHA_APP)
	
	INSERT INTO BOBBY_TABLES.OPERACIONES
	VALUES(@ORIGEN, @MONEDA, @FECHA, @IMPORTE)
	
	SET @OPERACION = @@IDENTITY
	
	IF @ORIGEN = @DESTINO
		SET @COSTO_TRANSF = 0
	ELSE
	BEGIN
		SELECT @COSTO_TRANSF = T.COSTO_TRANSACCION, @TIPO_CUENTA = T.TIP_ID FROM BOBBY_TABLES.TIPOS_CUENTA T, BOBBY_TABLES.CUENTAS C
		WHERE C.TIPO = T.TIP_ID
		
		INSERT INTO BOBBY_TABLES.COMISIONES(DESCRIPCION, OPERACION, CUENTA, TIPO_CUENTA, IMPORTE, FECHA)
		VALUES('Costos de transferencia', @OPERACION, @ORIGEN, @TIPO_CUENTA, @IMPORTE, @FECHA)
	END
	
	INSERT INTO BOBBY_TABLES.TRANSFERENCIAS
	VALUES(@OPERACION, @DESTINO, @COSTO_TRANSF)
	
	UPDATE BOBBY_TABLES.CUENTAS SET
		SALDO = SALDO - @IMPORTE
	WHERE CUE_ID = @ORIGEN
	
	UPDATE BOBBY_TABLES.CUENTAS SET
		SALDO = SALDO + @IMPORTE
	WHERE CUE_ID = @DESTINO
END --COMMIT


GO
CREATE PROCEDURE BOBBY_TABLES.COMISIONES_USUARIO(@ID INT) AS
BEGIN
	SELECT F.COM_ID, F.DESCRIPCION, F.FECHA, F.IMPORTE, F.OPERACION, C.CUE_ID, F.TIPO_CUENTA FROM BOBBY_TABLES.COMISIONES F, BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.CUENTAS C
	WHERE P.USUARIO = @ID AND
		  F.CUENTA = C.CUE_ID AND
		  P.CLI_ID = C.CLIENTE AND
		  F.FACTURA IS NULL
END


------------------------------------------------------------------------------------
--------------------------------CONSULTA SALDOS-------------------------------------
------------------------------------------------------------------------------------
GO
CREATE PROCEDURE BOBBY_TABLES.ULTIMOS_DEPOSITOS(@CUENTA NUMERIC(18,0)) AS
BEGIN
	SELECT TOP 5 @CUENTA AS Cuenta, O.IMPORTE AS Importe, M.NOMBRE AS Moneda, O.FECHA AS Fecha, '************' + T.LIMPIO AS Tarjeta FROM BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.DEPOSITOS D, BOBBY_TABLES.TARJETAS T, BOBBY_TABLES.MONEDAS M
	WHERE O.CUENTA = @CUENTA AND
		  O.OPE_ID = D.DEP_ID AND
		  D.TARJETA = T.TAR_ID AND
		  O.MONEDA = M.MON_ID
	ORDER BY Fecha DESC
END

GO
CREATE PROCEDURE BOBBY_TABLES.ULTIMOS_RETIROS(@CUENTA NUMERIC(18,0)) AS
BEGIN
	SELECT TOP 5 @CUENTA AS Cuenta, O.IMPORTE AS Importe, M.NOMBRE AS Moneda, O.FECHA AS Fecha, C.CHE_ID AS Cheque, B.NOMBRE AS Banco FROM BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.RETIROS_EFECTIVO R, BOBBY_TABLES.CHEQUES C, BOBBY_TABLES.BANCOS B, BOBBY_TABLES.MONEDAS M
	WHERE O.CUENTA = @CUENTA AND
		  O.OPE_ID = R.RET_ID AND
		  R.CHEQUE = C.CHE_ID AND
		  C.BANCO = B.BAN_ID AND
		  O.MONEDA = M.MON_ID
	ORDER BY Fecha DESC
END

GO
CREATE PROCEDURE BOBBY_TABLES.ULTIMAS_TRANSFERENCIAS(@CUENTA NUMERIC(18,0)) AS
BEGIN
	SELECT @CUENTA AS Cuenta_Destino, C.CUE_ID AS Cuenta_Origen, P.NOMBRE + ' ' + P.APELLIDO AS Cliente, O.IMPORTE AS Importe, T.COSTO AS Costo, M.NOMBRE AS Moneda, O.FECHA AS Fecha FROM BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.TRANSFERENCIAS T, BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.MONEDAS M
	WHERE O.CUENTA = @CUENTA AND
		  O.OPE_ID = T.TRA_ID AND
		  T.CUENTA_DESTINO = C.CUE_ID AND
		  C.CLIENTE = P.CLI_ID AND
		  O.MONEDA = M.MON_ID
	UNION
	SELECT C.CUE_ID AS Cuenta_Destino, @CUENTA AS Cuenta_Origen, P.NOMBRE + ' ' + P.APELLIDO AS Cliente, O.IMPORTE AS Importe, T.COSTO AS Costo, M.NOMBRE AS Moneda, O.FECHA AS Fecha FROM BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.TRANSFERENCIAS T, BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.MONEDAS M
	WHERE O.CUENTA = C.CUE_ID AND
		  O.OPE_ID = T.TRA_ID AND
		  T.CUENTA_DESTINO = @CUENTA AND
		  C.CLIENTE = P.CLI_ID AND
		  O.MONEDA = M.MON_ID
	ORDER BY Fecha DESC
END




------------------------------------------------------------------------------------
--------------------------------LISTADO ESTADÍSTICO---------------------------------
------------------------------------------------------------------------------------

--PUNTO 1 LISTADO ESTADÍSTICO TODO
GO
CREATE PROCEDURE BOBBY_TABLES.CLIENTES_CON_CUENTAS_INHABILITADAS_POR_AUSENCIA_DE_PAGO(@FECHA_INICIO_APP VARCHAR(30), @FECHA_FIN_APP VARCHAR(30)) AS
BEGIN
	DECLARE @FECHA_INICIO DATETIME, @FECHA_FIN DATETIME
	
	SET @FECHA_INICIO = CONVERT(DATETIME, @FECHA_INICIO_APP)
	SET @FECHA_FIN = CONVERT(DATETIME, @FECHA_FIN_APP)
	
	SELECT TOP 5 P.CLI_ID AS ID_Cliente, P.NOMBRE AS Nombre, P.APELLIDO AS Apellido, COUNT(C.CUE_ID) AS Cuentas, SUM(F.IMPORTE) AS Deuda_Total FROM BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.COMISIONES F, BOBBY_TABLES.ESTADOS_CUENTA E
	WHERE P.CLI_ID = C.CLIENTE AND
		  C.ESTADO = E.EST_ID AND
		  E.NOMBRE = 'Deshabilitada' AND
		  F.CUENTA = C.CUE_ID AND
		  F.FACTURA IS NULL AND
		  F.FECHA BETWEEN @FECHA_INICIO AND @FECHA_FIN
	GROUP BY P.CLI_ID, P.NOMBRE, P.APELLIDO
	ORDER BY DEUDA_TOTAL DESC, CUENTAS DESC
END


--PUNTO 2 LISTADO ESTADÍSTICO (SE INTERPRETA COMO COMISIÓN A LOS COSTOS GENERADOS POR TRANSFERENCIAS)
GO
CREATE PROCEDURE BOBBY_TABLES.CLIENTES_CON_MAS_COMISIONES_FACTURADAS(@FECHA_INICIO_APP VARCHAR(30), @FECHA_FIN_APP VARCHAR(30)) AS
BEGIN
	DECLARE @FECHA_INICIO DATETIME, @FECHA_FIN DATETIME
	
	SET @FECHA_INICIO = CONVERT(DATETIME, @FECHA_INICIO_APP)
	SET @FECHA_FIN = CONVERT(DATETIME, @FECHA_FIN_APP)
	
	SELECT TOP 5 P.CLI_ID AS ID_Cliente, P.NOMBRE AS Nombre, P.APELLIDO AS Apellido, COUNT(T.TRA_ID) AS Cantidad_Comisiones, SUM(F.IMPORTE) AS Total_Comisiones FROM BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.TRANSFERENCIAS T, BOBBY_TABLES.OPERACIONES O, BOBBY_TABLES.COMISIONES F
	WHERE P.CLI_ID = C.CLIENTE AND
		  O.OPE_ID = T.TRA_ID AND
		  O.CUENTA = C.CUE_ID AND
		  F.OPERACION = T.TRA_ID AND
		  F.FACTURA IS NOT NULL AND
		  F.FECHA BETWEEN @FECHA_INICIO AND @FECHA_FIN
	GROUP BY P.CLI_ID, P.NOMBRE, P.APELLIDO
	ORDER BY CANTIDAD_COMISIONES DESC, TOTAL_COMISIONES DESC
END
--PUNTO 3 LISTADO ESTADÍSTICO
GO
CREATE PROCEDURE BOBBY_TABLES.CLIENTES_CON_MAYOR_TRANSFERENCIA_ENTRE_CUENTAS_PROPIAS(@FECHA_INICIO_APP VARCHAR(30), @FECHA_FIN_APP VARCHAR(30)) AS
BEGIN
	DECLARE @FECHA_INICIO DATETIME, @FECHA_FIN DATETIME
	
	SET @FECHA_INICIO = CONVERT(DATETIME, @FECHA_INICIO_APP)
	SET @FECHA_FIN = CONVERT(DATETIME, @FECHA_FIN_APP)
	
	SELECT TOP 5 P.CLI_ID AS ID_Cliente, P.NOMBRE AS Nombre, P.APELLIDO AS Apellido, COUNT(T.TRA_ID) AS Cantidad_Transferencias FROM BOBBY_TABLES.CLIENTES P, BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.TRANSFERENCIAS T, BOBBY_TABLES.OPERACIONES O
	WHERE P.CLI_ID = C.CLIENTE AND
		  O.OPE_ID = T.TRA_ID AND
		  O.CUENTA = C.CUE_ID AND
		  T.CUENTA_DESTINO = C.CUE_ID AND
		  O.FECHA BETWEEN @FECHA_INICIO AND @FECHA_FIN
	GROUP BY P.CLI_ID, P.NOMBRE, P.APELLIDO
	ORDER BY CANTIDAD_TRANSFERENCIAS DESC
END

--PUNTO 4 LISTADO ESTADÍSTICO
GO
CREATE PROCEDURE BOBBY_TABLES.PAISES_CON_MAS_MOVIMIENTOS(@FECHA_INICIO_APP VARCHAR(30), @FECHA_FIN_APP VARCHAR(30)) AS
BEGIN
	DECLARE @FECHA_INICIO DATETIME, @FECHA_FIN DATETIME
	
	SET @FECHA_INICIO = CONVERT(DATETIME, @FECHA_INICIO_APP)
	SET @FECHA_FIN = CONVERT(DATETIME, @FECHA_FIN_APP)
	
	SELECT TOP 5 P.NOMBRE AS Pais, COUNT(T.TRA_ID) AS Cantidad_Movimientos FROM BOBBY_TABLES.PAISES P, BOBBY_TABLES.CUENTAS C, BOBBY_TABLES.TRANSFERENCIAS T, BOBBY_TABLES.OPERACIONES O
	WHERE T.TRA_ID = O.OPE_ID AND
		  (O.CUENTA = C.CUE_ID OR
		  T.CUENTA_DESTINO = C.CUE_ID) AND
		  P.PAI_ID = C.PAIS AND
		  O.FECHA BETWEEN @FECHA_INICIO AND @FECHA_FIN
	GROUP BY P.PAI_ID, P.NOMBRE
	ORDER BY CANTIDAD_MOVIMIENTOS DESC
END

--PUNTO 5 LISTADO ESTADÍSTICO
GO
CREATE PROCEDURE BOBBY_TABLES.FACTURADO_PARA_CADA_TIPO(@FECHA_INICIO_APP VARCHAR(30), @FECHA_FIN_APP VARCHAR(30)) AS
BEGIN
	DECLARE @FECHA_INICIO DATETIME, @FECHA_FIN DATETIME
	
	SET @FECHA_INICIO = CONVERT(DATETIME, @FECHA_INICIO_APP)
	SET @FECHA_FIN = CONVERT(DATETIME, @FECHA_FIN_APP)

	SELECT TOP 5 T.NOMBRE AS Tipo, SUM(F.IMPORTE) AS Facturado FROM BOBBY_TABLES.TIPOS_CUENTA T, BOBBY_TABLES.COMISIONES F
	WHERE F.TIPO_CUENTA = T.TIP_ID AND
		  F.FACTURA IS NOT NULL AND
		  F.FECHA BETWEEN @FECHA_INICIO AND @FECHA_FIN
	GROUP BY T.TIP_ID, T.NOMBRE
	ORDER BY FACTURADO DESC
END